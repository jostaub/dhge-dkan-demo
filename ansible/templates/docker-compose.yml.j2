# Common Docker Container configuration
version: "2"
services:

  frontend:
    hostname: frontend
    build:
      context: .
      dockerfile: Dockerfile_Frontend
    image: dkanreactfrontend
    ports:
      - "8088:80"

    labels:
      - "traefik.enable=true"
      - "traefik.frontend.passHostHeader=true" #``, 
      - "traefik.http.routers.dkan-frontend.rule=Host(`{{ inventory_hostname }}`) && (Path(`/`, `/search`,`/api`,`/about`,`/publishers`) || PathPrefix(`/static`))"
      - "traefik.http.routers.dkan-frontend.priority=3"
      - "traefik.http.routers.dkan-frontend.entryPoints=websecure, web"

    depends_on:
      - web

    networks:
      - {{ dkan_network_name }}

  demo-files:
    hostname: demoweb
    image: nginx
    ports:
      - "8099:80"

    volumes:
      - "{{ dkan_container_config_path }}/demo:/usr/share/nginx/html"

    labels:
      - "traefik.enable=true"
      - "traefik.frontend.passHostHeader=true"
      - "traefik.http.routers.demo-files.rule=Host(`{{ inventory_hostname }}`) && PathPrefix(`/demo-files`)"
      - "traefik.http.routers.demo-files.priority=2"
      - "traefik.http.middlewares.stripdemo.stripprefix.prefixes=/demo-files"
      - "traefik.http.routers.demo-files.middlewares=stripdemo"
      - "traefik.http.routers.demo-files.entryPoints=websecure, web"

    networks:
      - {{ dkan_network_name }}

  web:
    hostname: web
    build:
      context: .
      dockerfile: Dockerfile_DKAN
    image: dkanweb
    ports:
      - "8077:80"
      - "443"
      - "8888"
    #volumes:
      #- "{{ dkan_demo_path }}/dkan-demo:/var/www/:delegated"
      #- "/home/staub/Desktop/dhge-dkan-demo/dkan-demo:/var/www/:delegated"

    env_file:
      - "{{ dkan_container_config_path }}/mysql.env"

    labels:
      - "traefik.enable=true"
      - "traefik.frontend.passHostHeader=true"
      - "traefik.http.routers.dkan-backend.rule=Host(`{{ inventory_hostname }}`)"
      - "traefik.http.routers.dkan-backend.priority=1"
      - "traefik.http.routers.dkan-backend.entryPoints=websecure, web"

    depends_on:
      - db

    networks:
      - {{ dkan_network_name }}

  db:
    hostname: db
    image: mariadb
    ports:
      - "3306"

    env_file:
      - "{{ dkan_container_config_path }}/mysql.env"

    volumes:
      - dkan-database:/var/lib/mysql
    
    networks:
      - {{ dkan_network_name }}

volumes:
  dkan-database:

networks:
  {{ dkan_network_name }}: